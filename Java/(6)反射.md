# 反射

## 1. 作用和缺点

### 1.1 作用

- 可以在运行时动态创建对象、获取对象的属性和方法、执行对象的方法
- 开发框架

### 1.2 缺点

- 增加了性能开销，由于涉及动态解析，无法用到某些 JVM 优化
- 破坏了封装性，`private` 的内容也能访问

## 2. 基本使用

### 2.1 获取 Class 对象

```
Class.forName("com.mysql.jdbc.Driver");

Class<?> cls = int.class;

String str = "aaa";
Class<?> cls = str.getClass();
```

### 2.2 判断对象的类型

```
String str = "aaa";
System.out.println(str instanceof String);
```

### 2.3 创建对象

```
class User {

    private String name;
    private int age;
    private String sex;
    public String nickname;

    public User(String name, int age, String sex, String nickname) {
        this.name = name;
        this.age = age;
        this.sex = sex;
        this.nickname = nickname;
    }
    
    private void dance(String flag) {
        System.out.println(flag + "private dance");
    }
    
    public void printUser() {
        StringBuilder sb = new StringBuilder()
                .append("姓名: ")
                .append(name)
                .append("\n")
                .append("年龄: ")
                .append(age)
                .append("\n")
                .append("性别: ")
                .append(sex)
                .append("\n")
                .append("别名: ")
                .append(nickname);
        System.out.println(sb);
    }
}

@Test
void Case1() throws NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException {
    Class<?> c = User.class;
    Constructor<?> constructor = c.getConstructor(String.class, int.class, String.class, String.class);
    Object user = constructor.newInstance("tiger", 23, "male", "fucker");
    System.out.println(user);
}
```

### 2.4 获取属性

获取的属性不包括父类属性。

```
@Test
void Case1() throws NoSuchFieldException {
    Class<?> c = User.class;

    Field name = c.getDeclaredField("name");    // 获取任意自定义属性
    System.out.println(name.getType()); // class java.lang.String
    System.out.println(name.getName()); // name

    Field nickname = c.getField("nickname");    // 获取 public 属性
    System.out.println(nickname.getType()); // class java.lang.String
    System.out.println(nickname.getName()); // nickname

    Field[] fields2 = c.getDeclaredFields(); // 获取所有自定义属性
    System.out.println(fields2.length);
    for (Field f : fields2) {
        System.out.println("---> " + f.getName());
    }

    Field[] fields1 = c.getFields(); // 获取所有 public 属性
    System.out.println(fields1.length);
    for (Field f : fields1) {
        System.out.println("+++> " + f.getName());
    }
}
```

### 2.5 获取方法

获取的属性不包括父类方法。

```
@Test
void Case1() throws NoSuchMethodException {
    Class<?> c = User.class;

    Method danceMethod = c.getDeclaredMethod("dance", String.class);    // 获取任意自定义方法
    System.out.println(danceMethod.getName()); // dance
    System.out.println(danceMethod.getParameterCount());    // 1
    System.out.println(Arrays.toString(danceMethod.getParameters()));   // [java.lang.String flag]
    System.out.println(danceMethod.getReturnType());    // void

    Method printUserMethod = c.getMethod("printUser");  // 获取 public 方法
    System.out.println(printUserMethod.getName());  // printUser
    System.out.println(printUserMethod.getParameterCount());    // 0
    System.out.println(Arrays.toString(printUserMethod.getParameters()));   // []
    System.out.println(printUserMethod.getReturnType());    // void

    Method[] methods = c.getDeclaredMethods();  // 获取所有自定义方法
    for (Method m : methods) {
        System.out.println("---> " + m.getName());
    }

    Method[] publicMethods = c.getMethods();    // 获取所有 public 方法
    for (Method m : publicMethods) {
        System.out.println("+++> " + m.getName());
    }
}
```

### 2.6 调用方法

```
@Test
void Case1() throws NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException {
    Class<?> c = User.class;
    Constructor<?> constructor = c.getConstructor(String.class, int.class, String.class, String.class);
    Object user = constructor.newInstance("tiger", 23, "male", "fucker");

    Method danceMethod = c.getDeclaredMethod("dance", String.class);
    danceMethod.setAccessible(true);    // 调用私有方法需要设置为 true
    Object result = danceMethod.invoke(user, "毒奶"); // 使用反射调用方法
    System.out.println(result);

    Method printUserMethod = c.getMethod("printUser");
    result = printUserMethod.invoke(user);
    System.out.println(result);
}
```
