# 更进一步

## Celery 对象

Celery 对象用来配置 Broker、Backend 的连接，用来将普通函数装饰成任务，是 Celery Client 的重要组成部分之一

根据 [官网的描述](https://docs.celeryproject.org/en/stable/userguide/application.html#application) ，Celery 对象是线程安全的

### Celery() 构造函数

常用参数说明：

- main=None：入口模块的名字（用项目名也可以）
- broker=None：Broker 的连接 URL，格式 `transport://userid:password@hostname:port/virtual_host`。 [详细](https://kombu.readthedocs.io/en/latest/userguide/connections.html#urls)
- backend=None：Backend 的连接 URL，格式 `db+scheme://user:password@host:port/dbname`。 [详细](https://docs.celeryproject.org/en/stable/userguide/configuration.html#database-backend-settings)
- timezone：设置时区。譬如 `Asia/Shanghai`
- autofinalize=True：如果为 True，那么在 Celery 对象完成前，如果注册任务，就会抛出 RuntimeError。一般保持默认值就行
- set_as_current=True：标记 Celery 对象为全局对象。一般保持默认值就行

后续还可以通过 Celery 对象的 `conf` 属性对配置进行新增、修改等。这个对象是一个实现了 `__getitem__()` 等方法的字典类型

## Task 对象

Task 可以粗略看作是消息，是贯穿 Celery 的重要组成部分。通常有两种方式创建 Task 对象，通过装饰器 `@app.task()` 或者继承 `celery.Task` 类

### Task 装饰器

装饰器可以接收参数，用来控制任务的行为。常用参数说明：

- name：任务名字。根据实际情况命名即可
- request：任务的详细描述。 [详见](https://docs.celeryproject.org/en/stable/userguide/tasks.html#task-request)
- max_retries=3：最大重试次数，仅在调用 `retry()` 时才生效，`None` 代表一直重试直到成功为止
- default_retry_delay=180：每次重试的间隔时间，单位秒
- rate_limit：任务执行频率限制，`None` 代表无限制，`100/s` 代表每秒最多执行 100 个此类任务，`100/m` 和 `100/h` 以此类推
- serializer="JSON"：任务默认的序列化方式
- compression：任务的压缩方式。对体积比较大的任务会有一定好处，取值有 gzip、bzip2 等
- backend：任务结果的存储地方。一般在 Celery 对象统一指定即可
- **⭐️ acks_late=False：消息的确认机制，默认是任务执行之前就确认，缺点是万一 Worker 中途崩溃，会导致消息丢失、任务漏执行。
    设置成 True，消息会在任务执行完毕之后才确认，提高了可靠性，同时要确保任务的幂等性⭐️**
- track_started=False：将正在运行的任务的状态改成 started。一般情况下不需要，但是对于长时间运行的任务会有比较好的监控效果

根据上述参数，一个比较健壮的任务配置应该这样：

```python
@app.task(
    bind=True,
    name="celery_demo.task.task1.add",
    acks_late=True,
    max_retries=5,
    default_retry_delay=60,
    rate_limit="10/s"
)
def task(self):
    print(self.requests)
    pass
```

### Task 类

### 重试
